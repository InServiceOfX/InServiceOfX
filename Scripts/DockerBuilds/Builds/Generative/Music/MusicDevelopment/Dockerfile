# This Dockerfile is automatically generated by con(cat)enating textfiles. It's
# automatically concatenated by running a shell script (e.g.
# SetupPyTorchGPUDocker.sh) or doing something like, in command line,
# cat Dockerfile.header Dockerfile.base ..


# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/running.html
# Also, see
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch
# Check for the latest version on this page, on the left:
# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/running.html
# Look for the PyTorch Release Notes.
# Also, try
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch/tags
# and click on "Tags" on the top center for the different tags.

# As of March 26, 2024, there's 24.03.
# By doing nvcc --version, one can see that from 24.03, CUDA is 12.4. From
# 24.02, CUDA is 12.3.r12.3. For OpenCV and this issue, let's stay with < 12.4.
# Issue: https://github.com/opencv/opencv_contrib/issues/3690
# Furthermore, cudnnRNNForwardInference was removed in 9.0 of cuDNN:
# https://docs.nvidia.com/deeplearning/cudnn/api/overview.html
# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/rel-24-01.html
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# Set the working directory in the container
# https://docs.docker.com/engine/reference/builder/
ENV THIRD_PARTY=/ThirdParty
WORKDIR /

## Update apt, pip, and do pip installs.
RUN apt-get update && \
  apt-get install --upgrade -y ccache && \
  python -m pip install --upgrade pip && \
  #
  #
  # Do more pip installs.
  # Reads key-value pairs from .env file to set environment variables; in
  # particular for Open AI API keys for LangChain.
  pip install --upgrade python-dotenv




RUN apt-get -y install build-essential ccache libboost-all-dev \
  libtbb-dev

# Install prerequisites for Kitware repository
RUN apt-get install -y ca-certificates gpg wget

# If kitware-archive-keyring package hasn't been installed previously, manually
# obtain a copy of signing key:
RUN (test -f /usr/share/doc/kitware-archive-keyring/copyright) || \
  (wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | \
    gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null) && \
  # Add repository to sources list and update.
  # For Ubuntu Jammy Jellyfish (22.04):
  echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] \
    https://apt.kitware.com/ubuntu/ noble main' | \
      tee /etc/apt/sources.list.d/kitware.list >/dev/null && \
  apt-get update && \
  # If kitware-archive-keyring package hasn't been installed previously, remove
  # manually obtained signed key to make room for package:
  test -f /usr/share/doc/kitware-archive-keyring/copyright || \
  rm /usr/share/keyrings/kitware-archive-keyring.gpg && \
  # Install kitware-archive-keyring package to ensure keyring stays up to date
  # as kitware rotates keys.
  apt-get install kitware-archive-keyring && \
  apt-get install -y cmake


### Huggingface

## transformers (hugging face), required to run most popular diffusion models.
# Results in the following:
# transformers               5.0.0.dev0                           /ThirdParty/transformers
RUN git clone https://github.com/huggingface/transformers.git /ThirdParty/transformers && \
  cd /ThirdParty/transformers && \
  # main branch, Commits on Nov 15, 2025
  git checkout 66d57110f089789ae285cc9d54d3bf051123246b && \
  # Install editable install from source.
  # See https://huggingface.co/docs/transformers/installation#installing-from-source
  pip install -e . && \
  cd /



# https://huggingface.co/facebook/musicgen-medium
# Audiocraft Usage
# Nov 30 ffmpeg/noble 7:6.1.1-3ubuntu5 amd64
# libsox-fmt-all/noble 14.4.2+git20190427-4build4 amd64
RUN apt-get update && apt-get install -y ffmpeg libsox-fmt-all

RUN pip install pymusiclooper==3.6.0 torchaudio==2.9.1

# audiocraft                 1.4.0a2                              /ThirdParty/audiocraft
# Be wary of installing xformers,
# pip install -dry-run xformers would make the following change:
# Would install nvidia-cublas-cu12-12.8.4.1 nvidia-cuda-cupti-cu12-12.8.90 nvidia-cuda-nvrtc-cu12-12.8.93 nvidia-cuda-runtime-cu12-12.8.90 nvidia-cudnn-cu12-9.10.2.21 nvidia-cufft-cu12-11.3.3.83 nvidia-cufile-cu12-1.13.1.3 nvidia-curand-cu12-10.3.9.90 nvidia-cusolver-cu12-11.7.3.90 nvidia-cusparse-cu12-12.5.8.93 nvidia-cusparselt-cu12-0.7.1 nvidia-nccl-cu12-2.27.5 nvidia-nvjitlink-cu12-12.8.93 nvidia-nvshmem-cu12-3.3.20 nvidia-nvtx-cu12-12.8.90 torch-2.9.0 triton-3.5.0 xformers-0.0.33.post1
RUN git clone https://github.com/InServiceOfX/audiocraft.git /ThirdParty/audiocraft && \
  cd /ThirdParty/audiocraft && \
  # master branch as of Nov 30, 2025
  git checkout 7a6270e00c40de612825679af044678632ed8332 && \
  # pip installation of audiocraft changes too many package versions, such as
  # numpy-1.26.4 and torch-2.9.1. This is confirmed by running
  # pip install --dry-run .
  pip install --no-deps -e . && \
  cd /

# Note:
# scipy                      1.16.3



# https://docs.x.ai/docs/tutorial
RUN pip install groq instructor openai xai-sdk

# apt list --installed
# ccache/noble,now 4.9.1-1 amd64 [installed]
# cmake/noble,now 4.2.0-0kitware1ubuntu24.04.1 amd64 [installed]
# cpp-13/noble-updates,noble-security,now 13.3.0-6ubuntu2~24.04 amd64 [installed,automatic]
# ffmpeg/noble,now 7:6.1.1-3ubuntu5 amd64 [installed]
# g++-13/noble-updates,noble-security,now 13.3.0-6ubuntu2~24.04 amd64 [installed,automatic]
# python3.12/now 3.12.3-1ubuntu0.8 amd64 [installed,upgradable to: 3.12.3-1ubuntu0.9]
# sox/noble,now 14.4.2+git20190427-4build4 amd64 [installed]



# Install PulseAudio development libraries BEFORE building Mixxx
RUN apt-get update && apt-get install -y \
  alsa-utils \
  alsa-base \
  libasound2-dev \
  libjack-jackd2-dev \
  libpulse-dev \
  libpulse0 \
  pulseaudio \
  pulseaudio-utils \

  && rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/mixxxdj/mixxx.git /ThirdParty/mixxx && \
  cd /ThirdParty/mixxx && \
  # main branch as of Nov 30, 2025
  git checkout 2d79b10f07bed9a5711946b8ba96e87032a25854 && \
  # Remove sudo from debian_buildenv.sh to avoid issues with Docker.
  sed 's/sudo //g' tools/debian_buildenv.sh > tools/debian_buildenv_docker.sh && \
  chmod +x tools/debian_buildenv_docker.sh && \
  ./tools/debian_buildenv_docker.sh setup && \
  mkdir Build && \
  cd Build && \
  cmake .. && \
  cmake --build .




