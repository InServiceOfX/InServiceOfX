# This Dockerfile is automatically generated by con(cat)enating textfiles. It's
# automatically concatenated by running a shell script (e.g.
# SetupPyTorchGPUDocker.sh) or doing something like, in command line,
# cat Dockerfile.header Dockerfile.base ..


# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/running.html
# Also, see
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch
# Check for the latest version on this page, on the left:
# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/running.html
# Look for the PyTorch Release Notes.
# Also, try
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch/tags
# and click on "Tags" on the top center for the different tags.

# As of March 26, 2024, there's 24.03.
# By doing nvcc --version, one can see that from 24.03, CUDA is 12.4. From
# 24.02, CUDA is 12.3.r12.3. For OpenCV and this issue, let's stay with < 12.4.
# Issue: https://github.com/opencv/opencv_contrib/issues/3690
# Furthermore, cudnnRNNForwardInference was removed in 9.0 of cuDNN:
# https://docs.nvidia.com/deeplearning/cudnn/api/overview.html
# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/rel-24-01.html
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# Set the working directory in the container
# https://docs.docker.com/engine/reference/builder/
ENV THIRD_PARTY=/ThirdParty
WORKDIR ${THIRD_PARTY}

## Update apt, pip, and do pip installs.
RUN apt-get update && \
  apt-get install --upgrade -y ccache && \
  python -m pip install --upgrade pip && \
  #
  #
  # Do more pip installs.
  # Reads key-value pairs from .env file to set environment variables; in
  # particular for Open AI API keys for LangChain.
  pip install --upgrade python-dotenv && \
  #
  #
  # Install Poetry
  # https://python-poetry.org/docs/#installing-with-the-official-installer
  curl -sSL https://install.python-poetry.org | python3 - && \
  # https://python-poetry.org/docs/#installing-with-the-official-installer
  # Step 3, you have to add poetry to your PATH, which on UNIX is in
  # $HOME/.local/bin
  echo "export PATH=/root/.local/bin:$PATH" >> $HOME/.bashrc



## HuggingFace

## transformers (hugging face), required to run most popular diffusion models.
RUN git clone https://github.com/huggingface/transformers.git /ThirdParty/transformers && \
  cd /ThirdParty/transformers && \
  git checkout main && \
  # Install editable install from source.
  # See https://huggingface.co/docs/transformers/installation#installing-from-source
  pip install -e . && \
  #
  #
## accelerate - speeds up model loading for inference and training
  git clone https://github.com/huggingface/accelerate.git /ThirdParty/accelerate && \
  cd /ThirdParty/accelerate && \
  git checkout main && \
  pip install -e . && \
  cd /
  #
  #





RUN pip install --upgrade pip && \
  pip install --upgrade scipy && \
  # Upgrade Pytorch i.e. torch to be stable 2.6.
  pip install -U torch && \
  # Upgrade from 2.4 because otherwise this error is obtained:
  # ImportError: /usr/local/lib/python3.12/dist-packages/flash_attn_2_cuda.cpython-312-x86_64-linux-gnu.so: undefined symbol: _ZN3c105ErrorC2ENS_14SourceLocationENSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE
  # https://github.com/Dao-AILab/flash-attention
  # Set environment variable MAX_JOBS because otherwise ninja might run too
  # many parallel compilation jobs that could exhaust the amount of RAM.
  pip uninstall -y flash-attn && \
  MAX_JOBS=8 pip install flash-attn --no-build-isolation && \
  # Install xformers for audiocraft as xformers is one of its requirements.
  # See this for how we adapted the installation instructions for CUDA 12.6.
  # https://github.com/facebookresearch/xformers
  pip install -U xformers --index-url https://download.pytorch.org/whl/cu126 && \
  # For this error:
  # ImportError: /usr/local/lib/python3.12/dist-packages/fused_layer_norm_cuda.cpython-312-x86_64-linux-gnu.so: undefined symbol: _ZN3c106detail14torchCheckFailEPKcS2_jRKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE
  # I uninstall apex:
  # https://github.com/huggingface/diffusers/issues/8624#issuecomment-2180405409
  # "I am running pytorch 2.x which provides much of what apex did for pytorch
  #1, so I resolved the issue by just uninstalling apex."
  pip uninstall -y apex




# https://huggingface.co/facebook/musicgen-medium
# Audiocraft Usage
RUN apt-get install -y ffmpeg

RUN git clone https://github.com/InServiceOfX/audiocraft.git /ThirdParty/audiocraft && \
  cd /ThirdParty/audiocraft && \
  git checkout master && \
  pip install -e . && \
  cd /




