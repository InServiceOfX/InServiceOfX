# This Dockerfile is automatically generated by con(cat)enating textfiles. It's
# automatically concatenated by running a shell script (e.g.
# SetupPyTorchGPUDocker.sh) or doing something like, in command line,
# cat Dockerfile.header Dockerfile.base ..

# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/running.html
# Also, see
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch
# Check for the latest version on this page, on the left:
# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/running.html
# Look for the PyTorch Release Notes.
# Also, try
# https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch/tags
# and click on "Tags" on the top center for the different tags.

# As of Sept. 1, 2023
FROM nvcr.io/nvidia/pytorch:24.02-py3

# Set the working directory in the container
# https://docs.docker.com/engine/reference/builder/
ENV THIRD_PARTY=/ThirdParty
WORKDIR ${THIRD_PARTY}

# pip installations.

## Update pip.
RUN python -m pip install --upgrade pip && \
  pip install --upgrade jupyter && \
  pip install --upgrade ipywidgets && \
  # accelerate is to use transformers.TrainingArguments
  pip install --upgrade accelerate && \
  # Reads key-value pairs from .env file to set environment variables; in
  # particular for Open AI API keys for LangChain.
  pip install --upgrade python-dotenv && \
  # For WebBaseLoader for LangChain retrieval.
  pip install --upgrade beautifulsoup4 && \
  # For vector search example from https://youtu.be/JEBDfGqrAUA?si=t_XzLp1QH9qMMcVp
  pip install --upgrade pymongo && \
  # For Langchain, for langchain.document_loaders.DirectoryLoader
  pip install --upgrade unstructured[all-docs] && \
  # For the Vector Search Tutorial, Project 2, https://youtu.be/JEBDfGqrAUA?si=M5rZOgqQem0Hj4L6
  pip install --upgrade gradio && \
  # For ChromaDB, vector store or embedding database.
  pip install --upgrade chromadb
## LangChain needs a FAISS.
## FAISS

# These arguments are *not* global. They don't last past this layer, defined by
# the RUN docker command. See the example from here:
# https://docs.docker.com/build/guide/build-args/
# and notice how "close" or "local" the ARG's are to the "layer" it's used in.

ARG DISABLE_RAFT="OFF"
ARG COMPUTE_CAPABILITY="75;72"

# First, install dependencies, including swig, that's needed by Python.
RUN apt-get update && apt-get install -y swig && \
  git clone https://github.com/ernestyalumni/faiss.git /ThirdParty/faiss && \
  echo "This is disable raft: ${DISABLE_RAFT} and this is compute capability: ${COMPUTE_CAPABILITY}" && \
  if [ "$DISABLE_RAFT" = "ON" ]; then \
    cd /ThirdParty/faiss/ && \
    bash ./scripts/BuildForGPU.sh --disable-raft \
      --compute-capability ${COMPUTE_CAPABILITY} && cd -; \
  else \
    cd /ThirdParty/faiss/ && \
    bash ./scripts/BuildForGPU.sh --compute-capability ${COMPUTE_CAPABILITY} && \
      cd -; \
  fi

## LangChain

### https://python.langchain.com/docs/get_started/introduction
### The LangChain libraries themselves are made up of several different packages
### and we'll install 3 of them:
### langchain: Chains, agents, and retrieval strategies that make up an
### application's cognitive architecture.
### langchain-core: Base abstractions and LangChain Expression Language.
### langchain-community: Third party integrations.

RUN git clone https://github.com/ernestyalumni/langchain.git /ThirdParty/langchain && \
  cd /ThirdParty/langchain/libs/langchain && \
  git checkout master && \
  # Install editable install from source.
  # See https://python.langchain.com/docs/get_started/installation
  pip install -e . && \
  cd ../core && \
  pip install -e . && \
  cd ../community && \
  pip install -e . && \
  # Install partners, which include Anthropic, Mistral AI, Open AI, etc.
  cd ../partners && \
  cd anthropic && \
  pip install -e . && \
  cd ../mistralai && \
  pip install -e . && \
  cd ../openai && \
  pip install -e . && \
  cd ../together && \
  pip install -e .

## HuggingFace

## transformers (hugging face)
RUN git clone https://github.com/ernestyalumni/transformers.git /ThirdParty/transformers && \
  cd /ThirdParty/transformers && \
  git checkout master && \
  # Install editable install from source.
  # See https://huggingface.co/docs/transformers/installation#installing-from-source
  pip install -e .

## datasets (hugging face)
RUN git clone https://github.com/huggingface/datasets.git /ThirdParty/datasets && \
  cd /ThirdParty/datasets && \
  git checkout main && \
  pip install -e .

### Single, almost one-off, code/repositories

## neuraloperator
RUN git clone https://github.com/ernestyalumni/neuraloperator /ThirdParty/neuraloperator && \
  cd /ThirdParty/neuraloperator && \
  git checkout development && \
  # Install a project in editable mode from local project.
  pip install -r requirements.txt && \
  pip install -e .

## mamba
RUN git clone https://github.com/ernestyalumni/mamba.git /ThirdParty/mamba && \
  cd /ThirdParty/mamba && \
  git checkout master && \
  # Install a project in editable mode from local project.
  pip install -r ./scripts/requirements.txt && \
  pip install -e .

## GaLore

RUN git clone https://github.com/ernestyalumni/GaLore.git /ThirdParty/GaLore && \
  cd /ThirdParty/GaLore && \
  git checkout development
