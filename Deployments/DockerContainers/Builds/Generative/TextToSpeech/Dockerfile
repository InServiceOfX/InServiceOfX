# --- Section: Dockerfile.header ---

# This Dockerfile is automatically generated by con(cat)enating textfiles.
#




# --- Section: Dockerfile.base ---

ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# Set the working directory in the container
# https://docs.docker.com/engine/reference/builder/
ENV THIRD_PARTY=/ThirdParty
WORKDIR /

## Update apt, pip, and do pip installs.
RUN apt-get update && \
  apt-get install --upgrade -y ccache && \
  python -m pip install --upgrade pip && \
  #
  #
  # Do more pip installs.
  # Reads key-value pairs from .env file to set environment variables; in
  # particular for Open AI API keys for LangChain.
  pip install --upgrade python-dotenv




# --- Section: Dockerfile.rust ---

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
  # https://rust-lang.github.io/rustup/installation/index.html
  # export PATH once, doing both Rust and poetry binaries.
  echo "export PATH=/root/.cargo/bin:$PATH" >> $HOME/.bashrc




# --- Section: Dockerfile.huggingface ---

# We seek here to install a working minimal of modules from HuggingFace.
RUN git clone https://github.com/InServiceOfX/transformers.git /ThirdParty/transformers && \
  cd /ThirdParty/transformers && \
  # w0.0.1-vibevoice tag has main branch from 2025-09-11 and PR 40546 that has
  # VibeVoice implementation.
  git checkout w0.0.2-vibevoice && \
  # Install editable install from source.
  # See https://huggingface.co/docs/transformers/installation#installing-from-source
  pip install -e . && \
  #
  #
## accelerate - speeds up model loading for inference and training
  git clone https://github.com/huggingface/accelerate.git /ThirdParty/accelerate && \
  cd /ThirdParty/accelerate && \
  git checkout main && \
  pip install -e . && \
  #
  #
  # See Huggingface's transformers/src/transformers/pipelines/__init__.py for
  # def pipeline(..) where if config is None and isinstance(model, str) and case
  # when if is_peft_available().
  ## PEFT (Parameter-Efficient Fine-Tuning)
  git clone https://github.com/huggingface/peft /ThirdParty/peft && \
  cd /ThirdParty/peft && \
  pip install -e . && \
  #
  #
  pip install datasets && \
  #
  #
## Diffusers is needed by VibeVoice:
  # transformers/models/vibevoice/schedule/dpm_solver.py:23
  git clone https://github.com/huggingface/diffusers.git /ThirdParty/diffusers && \
  cd /ThirdParty/diffusers && \
  git checkout main && \
  pip install -e . && \
  cd / && \
  cd /
  #
  #




# --- Section: Dockerfile.pip_installs ---

RUN pip install torchaudio torchcodec torchvision

RUN git clone https://github.com/InServiceOfX/VibeVoice.git /ThirdParty/VibeVoice && \
  cd /ThirdParty/VibeVoice && \
  git checkout master && \
  cd /




# --- Section: Dockerfile.apt_installs ---

RUN apt-get update && apt-get install -y ffmpeg


